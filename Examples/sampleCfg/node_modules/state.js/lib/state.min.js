/*
 * Copyright (C) 2014 SINTEF <franck.fleurey@sintef.no>
 *
 * Licensed under the GNU LESSER GENERAL PUBLIC LICENSE, Version 3, 29 June 2007;
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * 	http://www.gnu.org/licenses/lgpl-3.0.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function t(e,n,i){function r(a,s){if(!n[a]){if(!e[a]){var u="function"==typeof require&&require
if(!s&&u)return u(a,!0)
if(o)return o(a,!0)
var c=new Error("Cannot find module '"+a+"'")
throw c.code="MODULE_NOT_FOUND",c}var h=n[a]={exports:{}}
e[a][0].call(h.exports,function(t){var n=e[a][1][t]
return r(n?n:t)},h,h.exports,t,e,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a])
return r}({1:[function(t,e){var n
!function(t){!function(t){t[t.Initial=0]="Initial",t[t.ShallowHistory=1]="ShallowHistory",t[t.DeepHistory=2]="DeepHistory",t[t.Choice=3]="Choice",t[t.Junction=4]="Junction",t[t.Terminate=5]="Terminate"}(t.PseudoStateKind||(t.PseudoStateKind={}))
t.PseudoStateKind}(n||(n={}))
var n
!function(t){var e=function(){function t(t){this.name=t}return t.prototype.getParent=function(){},t.prototype.getRoot=function(){return this.getParent().getRoot()},t.prototype.ancestors=function(){return(this.getParent()?this.getParent().ancestors():[]).concat(this)},t.prototype.accept=function(){},t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}()
t.Element=e}(n||(n={}))
var n,i=this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])
n.prototype=e.prototype,t.prototype=new n}
!function(t){var e=function(t){function e(e,n){t.call(this,e),this.vertices=[],this.state=n,this.state.regions.push(this),this.state.getRoot().clean=!1}return i(e,t),e.prototype.getParent=function(){return this.state},e.prototype.accept=function(t,e,n,i){return t.visitRegion(this,e,n,i)},e.defaultName="default",e}(t.Element)
t.Region=e}(n||(n={}))
var n
!function(t){var e=function(e){function n(n,i){e.call(this,n),this.transitions=[],i instanceof t.Region?this.region=i:i instanceof t.State&&(this.region=i.defaultRegion()),this.region&&(this.region.vertices.push(this),this.region.getRoot().clean=!1)}return i(n,e),n.prototype.getParent=function(){return this.region},n.prototype.to=function(e){var n=new t.Transition(this,e)
return this.transitions.push(n),this.getRoot().clean=!1,n},n}(t.Element)
t.Vertex=e}(n||(n={}))
var n
!function(t){var e=function(e){function n(n,i,r){void 0===r&&(r=t.PseudoStateKind.Initial),e.call(this,n,i),this.kind=r,this.isInitial()&&(this.region.initial=this)}return i(n,e),n.prototype.isHistory=function(){return this.kind===t.PseudoStateKind.DeepHistory||this.kind===t.PseudoStateKind.ShallowHistory},n.prototype.isInitial=function(){return this.kind===t.PseudoStateKind.Initial||this.isHistory()},n.prototype.accept=function(t,e,n,i){return t.visitPseudoState(this,e,n,i)},n}(t.Vertex)
t.PseudoState=e}(n||(n={}))
var n
!function(t){var e=function(e){function n(t,n){e.call(this,t,n),this.exitBehavior=[],this.entryBehavior=[],this.regions=[]}return i(n,e),n.prototype.defaultRegion=function(){var e
return this.regions.forEach(function(n){n.name===t.Region.defaultName&&(e=n)}),e||(e=new t.Region(t.Region.defaultName,this)),e},n.prototype.isFinal=function(){return 0===this.transitions.length},n.prototype.isSimple=function(){return 0===this.regions.length},n.prototype.isComposite=function(){return this.regions.length>0},n.prototype.isOrthogonal=function(){return this.regions.length>1},n.prototype.exit=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},n.prototype.entry=function(t){return this.entryBehavior.push(t),this.getRoot().clean=!1,this},n.prototype.accept=function(t,e,n,i){return t.visitState(this,e,n,i)},n}(t.Vertex)
t.State=e}(n||(n={}))
var n
!function(t){var e=function(t){function e(e,n){t.call(this,e,n)}return i(e,t),e.prototype.to=function(){throw"A FinalState cannot be the source of a transition."},e.prototype.accept=function(t,e,n,i){return t.visitFinalState(this,e,n,i)},e}(t.State)
t.FinalState=e}(n||(n={}))
var n
!function(t){var e=function(t){function e(e){t.call(this,e,void 0),this.clean=!1}return i(e,t),e.prototype.getRoot=function(){return this.region?this.region.getRoot():this},e.prototype.setLogger=function(t){return void 0===t&&(t=void 0),this.logger=t,this.clean=!1,this},e.prototype.accept=function(t,e,n,i){return t.visitStateMachine(this,e,n,i)},e}(t.State)
t.StateMachine=e}(n||(n={}))
var n
!function(t){var e=function(){function t(t,e){var n=this
this.source=t,this.target=e,this.transitionBehavior=[],this.traverse=[],this.guard=function(t){return t===n.source}}return t.prototype["else"]=function(){return this.guard=t.isElse,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.transitionBehavior.push(t),this.source.getRoot().clean=!1,this},t.prototype.accept=function(t,e,n,i){return t.visitTransition(this,e,n,i)},t.isElse=function(){return!1},t}()
t.Transition=e}(n||(n={}))
var n
!function(t){var e=function(){function t(){}return t.prototype.visitElement=function(){},t.prototype.visitRegion=function(t,e,n,i){var r=this,o=this.visitElement(t,e,n,i)
return t.vertices.forEach(function(t){t.accept(r,e,n,i)}),o},t.prototype.visitVertex=function(t,e,n,i){var r=this,o=this.visitElement(t,e,n,i)
return t.transitions.forEach(function(t){t.accept(r,e,n,i)}),o},t.prototype.visitPseudoState=function(t,e,n,i){return this.visitVertex(t,e,n,i)},t.prototype.visitState=function(t,e,n,i){var r=this,o=this.visitVertex(t,e,n,i)
return t.regions.forEach(function(t){t.accept(r,e,n,i)}),o},t.prototype.visitFinalState=function(t,e,n,i){return this.visitState(t,e,n,i)},t.prototype.visitStateMachine=function(t,e,n,i){return this.visitState(t,e,n,i)},t.prototype.visitTransition=function(){},t}()
t.Visitor=e}(n||(n={}))
var n
!function(t){var e=function(){function t(t){void 0===t&&(t="unnamed"),this.name=t,this.last={},this.isTerminated=!1}return t.prototype.setCurrent=function(t,e){this.last[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.last[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}()
t.StateMachineInstance=e}(n||(n={}))
var n
!function(t){function e(t,n,i){void 0===i&&(i=!0),n?(i&&t.clean===!1&&e(t),t.logger&&t.logger.log("initialise "+n),a(t.onInitialise,void 0,n)):(t.logger&&t.logger.log("initialise "+t.name),t.accept(new p,!1),t.clean=!0)}function n(t,n,i,r){return void 0===r&&(r=!0),t.logger&&t.logger.log(n+" evaluate "+i),r&&t.clean===!1&&e(t),n.isTerminated?!1:t.accept(h.instance,n,i)}function r(e,n){return e instanceof t.State?e.regions.every(function(t){return n.getCurrent(t).isFinal()}):!0}function o(t){u=t}function a(t,e,n,i){void 0===i&&(i=!1),t.forEach(function(t){t(e,n,i)})}function s(t,e){return t.region?s(t.region.state,e)&&e.getCurrent(t.region)===t:!0}t.initialise=e,t.evaluate=n,t.isComplete=r,t.setRandom=o
var u=function(t){return Math.floor(Math.random()*t)},c=function(){function t(){this.leave=[],this.beginEnter=[],this.endEnter=[],this.enter=[]}return t}(),h=function(e){function n(){e.apply(this,arguments)}return i(n,e),n.prototype.visitRegion=function(t,e,n){return e.getCurrent(t).accept(this,e,n)},n.prototype.visitPseudoState=function(e,n,i){var r,o=this
switch(e.kind){case t.PseudoStateKind.Initial:case t.PseudoStateKind.DeepHistory:case t.PseudoStateKind.ShallowHistory:if(1!==e.transitions.length)throw"Initial transition must have a single outbound transition from "+e
r=e.transitions[0]
break
case t.PseudoStateKind.Junction:var s,c
e.transitions.forEach(function(e){if(e.guard===t.Transition.isElse){if(c)throw"Multiple outbound transitions evaluated true"
c=e}else if(e.guard(i,n)){if(s)throw"Multiple outbound transitions evaluated true"
s=e}}),r=s||c
break
case t.PseudoStateKind.Choice:var h=[]
e.transitions.forEach(function(e){if(e.guard===t.Transition.isElse){if(c)throw"Multiple outbound else transitions found at "+o+" for "+i
c=e}else e.guard(i,n)&&h.push(e)}),r=0!==h.length?h[u(h.length)]:c}return r?(a(r.traverse,i,n),!0):!1},n.prototype.visitState=function(t,e,n){for(var i=!1,o=0,u=t.regions.length;u>o&&(!t.regions[o].accept(this,e,n)||(i=!0,s(t,e)));o++);if(!i){var c
t.transitions.forEach(function(t){if(t.guard(n,e)){if(c)throw new Error("Multiple outbound transitions evaluated true")
c=t}}),c&&(a(c.traverse,n,e),i=!0)}return i&&n!==t&&r(t,e)&&this.visitState(t,e,t),i},n.instance=new n,n}(t.Visitor),f=function(e){function n(){e.apply(this,arguments)}return i(n,e),n.prototype.visitTransition=function(t,e){t.target?t.target.region===t.source.region?this.visitLocalTransition(t,e):this.visitExternalTransition(t,e):this.visitInternalTransition(t)},n.prototype.visitInternalTransition=function(t){t.traverse=t.transitionBehavior},n.prototype.visitLocalTransition=function(t,e){t.traverse=e(t.source).leave.concat(t.transitionBehavior).concat(e(t.target).enter)},n.prototype.visitExternalTransition=function(t,e){for(var n=t.source.ancestors(),i=t.target.ancestors(),r=0,o=Math.min(n.length,i.length);o>r&&n[r]===i[r];)r++
for(t.traverse=e(r<n.length?n[r]:t.source).leave.slice(0),t.traverse=t.traverse.concat(t.transitionBehavior),r>=i.length&&(t.traverse=t.traverse.concat(e(t.target).beginEnter));r<i.length;)this.cascadeElementEntry(t,e,i[r++],r<i.length?i[r]:void 0)
t.traverse=t.traverse.concat(e(t.target).endEnter)},n.prototype.cascadeElementEntry=function(e,n,i,r){e.traverse=e.traverse.concat(n(i).beginEnter),i instanceof t.State&&this.cascadeOrthogonalRegionEntry(e,n,i,r)},n.prototype.cascadeOrthogonalRegionEntry=function(t,e,n,i){n.isOrthogonal()&&n.regions.forEach(function(n){n!==i&&(t.traverse=t.traverse.concat(e(n).enter))})},n}(t.Visitor),p=function(e){function n(){e.apply(this,arguments),this.behaviours={}}return i(n,e),n.prototype.behaviour=function(e){return e.qualifiedName||(e.qualifiedName=e.ancestors().map(function(t){return t.name}).join(t.Element.namespaceSeparator)),this.behaviours[e.qualifiedName]||(this.behaviours[e.qualifiedName]=new c)},n.prototype.visitElement=function(t){if(t.getRoot().logger){var e=this.behaviour(t),n=t.getRoot().logger
e.leave.push(function(e,i){n.log(i+" leave "+t)}),e.beginEnter.push(function(e,i){n.log(i+" enter "+t)})}},n.prototype.visitRegion=function(e,n){var i=this,r=this.behaviour(e)
e.vertices.forEach(function(r){r.accept(i,n||e.initial&&e.initial.kind===t.PseudoStateKind.DeepHistory)}),r.leave.push(function(t,n){a(i.behaviour(n.getCurrent(e)).leave,t,n)}),n||!e.initial||e.initial.isHistory()?r.endEnter.push(function(n,r,o){var s=e.initial;(o||e.initial.isHistory())&&(s=r.getCurrent(e)||e.initial),a(i.behaviour(s).enter,n,r,o||e.initial.kind===t.PseudoStateKind.DeepHistory)}):r.endEnter=r.endEnter.concat(this.behaviour(e.initial).enter),this.visitElement(e,n),r.enter=r.beginEnter.concat(r.endEnter)},n.prototype.visitVertex=function(t,e){this.visitElement(t,e),this.behaviour(t).endEnter.push(function(e,n){r(t,n)&&t.accept(h.instance,n,t)})},n.prototype.visitPseudoState=function(e,n){var i=this.behaviour(e)
this.visitVertex(e,n),e.kind===t.PseudoStateKind.Terminate&&i.beginEnter.push(function(t,e){e.isTerminated=!0}),i.enter=i.beginEnter.concat(i.endEnter)},n.prototype.visitState=function(t,e){var n=this,i=this.behaviour(t)
t.regions.forEach(function(t){var r=n.behaviour(t)
t.accept(n,e),i.leave=i.leave.concat(r.leave),i.endEnter=i.endEnter.concat(r.enter)}),this.visitVertex(t,e),i.leave=i.leave.concat(t.exitBehavior),i.beginEnter=i.beginEnter.concat(t.entryBehavior),i.beginEnter.push(function(e,n){t.region&&n.setCurrent(t.region,t)}),i.enter=i.beginEnter.concat(i.endEnter)},n.prototype.visitStateMachine=function(t,e){var n=this
this.visitState(t,e),t.accept(new f,function(t){return n.behaviour(t)}),t.onInitialise=this.behaviour(t).enter},n}(t.Visitor)}(n||(n={}))
var e=e
e.exports=n},{}],2:[function(t){!function(e){var n=document.currentScript
if(!n){var i=document.getElementsByTagName("script")
n=i[i.length-1]}e[n.attributes.target?n.attributes.target.textContent:"fsm"]=t("../lib/state.com.js")}(window)},{"../lib/state.com.js":1}]},{},[2])
