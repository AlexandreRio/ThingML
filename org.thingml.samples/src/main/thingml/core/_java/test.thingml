import "../test.thingml"

datatype Dumper
@java_type "org.thingml.devices.Dumper";
datatype long
@java_type "long";

thing TestDumpJava includes TestDump
@thingml_maven_dep "org.thingml.samples.utils"
{
   property device : Dumper = 'new org.thingml.devices.Dumper()'
 	property benchmark: Boolean = false
 	property time: long
	function write(string : String) 
	do
		if (benchmark == false)  do 
			'((org.thingml.devices.Dumper)' & device & ').write(' & string & ');'
			print(string) 
		end
	end
	
	statechart JavaHarness init Testing {
		property transitionsCount : Long = 0
		state Testing {
			on entry do
			''&time&' = System.currentTimeMillis();'
			end
            internal event m : dump?testOut
            action do write('Character.toString('&m.c&')')
            	transitionsCount=transitionsCount+1
            end
            internal event m : dump?perfTestOut
            action do //write(''&m.s&'+"\n"')
            	transitionsCount=transitionsCount+1
            end
            
            transition -> Failed 
            event dump?testFailure
            
            transition -> End
            event dumpEnd?testEnd
	    action ''&time& '= System.currentTimeMillis()-'&time&';'
            
            transition -> End
            event m: dumpEnd?perfTestSize
            action do 
	      ''&time& '= System.currentTimeMillis()-'&time&';'
            '((org.thingml.devices.Dumper)' & device & ').write(' & m.s & ');' 
            end
		}
		
		state Failed {
			on entry write("*FAILURE*")
		}

		state End {
			on entry do
				'try{java.io.PrintWriter pw = new java.io.PrintWriter("cputime");'
				'pw.println(""+'&time&');'
				'pw.close();}catch(Exception e){;}'
				print("End of thingml processus") 
				'((org.thingml.devices.Dumper)' & device & ').stop((int)'&transitionsCount&');'
			end
		}
	}
}