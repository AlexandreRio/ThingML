import "../../../../../org.thingml.samples/src/main/thingml/thingml.thingml"
import "../../../../../org.thingml.samples/src/main/thingml/datatypes.thingml"

thing fragment TestMsgs {
	message msg(prop1: Integer, prop2 : Integer);
	message ack(prop1: Integer, prop2 : Integer);
}

thing TestSimpleStreamOnReceive includes Test, TestMsgs
@test "hij # hio"
@conf "instance receive : ReceiveMsgs"
@conf "connector receive.receiveService => test.sendService"
{
	 provided port sendService {
		sends msg
		receives ack
	}

	property prop1 : Integer = 5
	property prop2 : Integer = 87

	statechart TestInit init Init {

		state Init {
			
            internal
            @stream ""
			event m : harnessIn?testIn
			guard m.c == '\'h\''
			action harnessOut!testOut(m.c)

			transition -> End
            @stream ""
			event m2 : harnessIn?testIn
			guard m2.c == '\'i\''
		}

		state End {
            on entry harnessOut!testOut('\'i\'')
            
            internal
            @stream ""
			event m : harnessIn?testIn
			guard m.c == '\'j\''
			action sendService!msg(prop1,prop2)

			internal
            @stream ""
			event resp : sendService?ack
			action do
                if(resp.prop1 == 5 and resp.prop2 == 87)
                    harnessOut!testOut('\'o\'')
            end
		}
	}
}

thing ReceiveMsgs includes TestMsgs, Test
{

	required port receiveService {
    		receives msg
    		sends ack
    }

    statechart ReceiveMsgs init Receive {
    	state Receive {
    		internal
            @stream ""
    		event e : receiveService?msg
    		action do
    			if(e.prop1 == 5 and e.prop2 == 87)
                    receiveService!ack(e.prop1,e.prop2)
    		end
    	}
    }

}