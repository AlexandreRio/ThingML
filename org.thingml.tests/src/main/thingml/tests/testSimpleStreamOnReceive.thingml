import "../../../../../org.thingml.samples/src/main/thingml/thingml.thingml"
import "../../../../../org.thingml.samples/src/main/thingml/datatypes.thingml"

thing fragment TestMsgs {
	message msg(prop1: Integer, prop2 : Integer);
	message ack(prop1: Integer, prop2 : Integer);
}

thing TestSimpleStreamOnReceive includes Test, TestMsgs
@test "hij # hio"
@conf "instance receive : ReceiveMsgs"
@conf "connector receive.receiveService => test.sendService"
{
	 provided port sendService {
		sends msg
		receives ack
	}

	property prop1 : Integer = 5
	property prop2 : Integer = 87

	statechart TestInit init Init {

		state Init {
			
            internal
			stream s1 from event harnessIn?testIn
			trigger s1->c == '\'h\''
			action harnessOut!testOut(s1->c) 

			transition -> End
			stream s2 from event harnessIn?testIn
			trigger s2->c == '\'i\''
		}

		state End {
            on entry do
                print "State : End"
                harnessOut!testOut('\'i\'')
            end
            
            internal
			stream s3 from event m : harnessIn?testIn
			trigger s3->c == '\'j\''
			action do 
                sendService!msg(prop1,prop2)
            end

			internal
			stream s4 from event resp : sendService?ack
            action harnessOut!testOut('\'o\'') 
		}
	}
}

thing ReceiveMsgs includes TestMsgs, Test
{

	required port receiveService {
    		receives msg
    		sends ack
    }

    statechart ReceiveMsgs init Receive {
    	state Receive {
            internal
    		stream s5 from event receiveService?msg
    		action do
    			if(s5->prop1 == 5 and s5->prop2 == 87) do
                    receiveService!ack(s5->prop1,s5->prop2)
                end
    		end
    	}
    }

}